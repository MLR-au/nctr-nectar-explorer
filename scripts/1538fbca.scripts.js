"use strict";angular.module("nectarExplorerApp",["ngCookies","ngResource","ngSanitize","ngRoute","ngAnimate"]).config(["$routeProvider",function(a){a.when("/:load/:as",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/vlabs/network"})}]),angular.module("nectarExplorerApp").controller("MainCtrl",["$scope","$window","$sce","$timeout","$routeParams","$location","Configuration","Helpers",function(a,b,c,d,e,f,g,h){var i=angular.element(b);i.bind("resize",function(){a.$apply(function(){var a=angular.element(document.querySelector("#header"));d3.select("svg").style("width",b.innerWidth).style("height",b.innerHeight-a[0].clientHeight)})});var j=g.load[e.load];d3.json("data/"+j,function(b,c){a.nodes=[],a.links=[];a.$apply(function(){var b=[];angular.forEach(c.nodes,function(a){b.push(a.id)}),angular.forEach(c.edges,function(c){var d={source:b.indexOf(c.source),target:b.indexOf(c.target),weight:1};a.links.push(d)}),a.nodes=c.nodes;var d=({nodes:a.nodes,links:a.links},h.convertToTree(c));a.drawNetwork=!1,a.drawTree=!1,"network"===e.as?(angular.forEach(d.children,function(b,c){d.children[c]._children=b.children,d.children[c].children=null,a.tree=d}),a.drawTree=!1,a.drawNetwork=!0,a.explorationMethod="hierarchy",a.url=f.url().replace("network","tree")):"tree"===e.as&&(a.tree=d,a.drawNetwork=!1,a.drawTree=!0,a.explorationMethod="network",a.url=f.url().replace("tree","network"))})})}]),angular.module("nectarExplorerApp").service("Helpers",function(){function a(a){var b,c={},d={};return angular.forEach(a.nodes,function(a){var e=a.attributes.custom_class;"1"===e?(b=a,b.children=[]):"2"===e?(a.children=[],c[a.id]=a):"1"!==e&&"2"!==e&&void 0!==e&&(d[a.id]=a)}),angular.forEach(a.edges,function(a){void 0!==c[a.source]?void 0!==d[a.target]&&c[a.source].children.push(d[a.target]):void 0!==c[a.target]&&void 0!==d[a.source]&&c[a.target].children.push(d[a.source])}),angular.forEach(c,function(a){b.children.push(a)}),b}var b={convertToTree:a};return b}),angular.module("nectarExplorerApp").constant("Configuration",{load:{nectar:"nectar.json",vlabs:"vlabs.json"}}),angular.module("nectarExplorerApp").directive("renderNetwork",["$window","$sce",function(a,b){return{templateUrl:"views/render-network.html",restrict:"E",scope:{data:"=ngModel"},link:function(c){function d(){var a=i(c.data),b=d3.layout.tree().links(a);m.nodes(a).links(b).start(),q=q.data(b,function(a){return a.target.id}),q.exit().remove(),q.enter().append("svg:path").attr("class","link"),r=r.data(a,function(a){return a.id}),r.exit().remove();var d=r.enter().append("g").attr("class","node").on("click",g).call(m.drag);d.filter(function(a){return"Virtual Laboratories"===a.id?!0:void 0}).append("image").attr("xlink:href","images/logo.png").attr("x",-100).attr("y",-100).attr("width",200).attr("height",200),d.filter(function(a){return"Virtual Laboratories"!==a.id?!0:void 0}).append("circle").attr("r",function(a){var b=a.attributes.custom_class;return"2"===b?30:20}).attr("fill",function(a){return f(a)}),d.append("text").filter(function(a){return"Virtual Laboratories"!==a.id?!0:void 0}).attr("dx",function(a){return a.x<0?-35:35}).attr("dy","0.35em").style("text-anchor",function(a){return a.x<0?"end":"start"}).text(function(a){return a.id}).style("font",function(){return"15px sans-serif"}),r.select("circle").style("fill",f).style("stroke",f)}function e(){q.attr("d",function(a){var b=a.target.x-a.source.x,c=a.target.y-a.source.y,d=Math.sqrt(b*b+c*c);return"M"+a.source.x+","+a.source.y+"A"+d+","+d+" 0 0,1 "+a.target.x+","+a.target.y}),r.attr("transform",function(a){return"translate("+a.x+","+a.y+")"})}function f(a){return a._children?"#3182bd":a.children?"#666":"#3182bd"}function g(a){h(a),d3.event.defaultPrevented||(a.children?(a._children=a.children,a.children=null):(a.children=a._children,a._children=null),d())}function h(d){void 0!==d.attributes.custom_url&&c.$apply(function(){c.iframePanelStyle={position:"fixed","z-index":"300",top:"100px",left:(a.innerWidth-700)/2,width:"720px",height:.8*a.innerHeight},c.iframeStyle={border:"0","border-radius":"8px","background-color":"white",overflow:"hidden"},c.nodeSelected=!0,c.targetUrl=b.trustAsResourceUrl(d.attributes.custom_url),c.iframeWidth=720,c.iframeHeight=.8*a.innerHeight})}function i(a){function b(a){a.children&&a.children.forEach(b),a.id||(a.id=++d),c.push(a)}var c=[],d=0;return b(a),c}var j=angular.element(document.querySelector("#header")),k=a.innerWidth,l=a.innerHeight-j[0].clientHeight;c.position={position:"absolute",top:j[0].clientHeight,left:"0"};var m=d3.layout.force().linkDistance(150).charge(-5e3).gravity(.05).size([k,l]).on("tick",e),n=function(){d3.select("svg").select("g").attr("transform","translate("+d3.event.translate+") scale("+d3.event.scale+")")},o=d3.behavior.zoom().scale([.8]).translate([k/8,50]).scaleExtent([0,8]).on("zoom",n),p=d3.select("#explorer").append("svg").attr("width",k).attr("height",l).attr("preserveAspectRatio","xMidYMid meet").call(o).append("g").attr("transform","translate("+k/8+",50)scale(.8,.8)"),q=p.selectAll(".link"),r=p.selectAll(".node");d(),c.dismiss=function(){c.nodeSelected=!1},c.openPage=function(){a.location.href=c.targetUrl}}}}]),angular.module("nectarExplorerApp").directive("renderTree",["$window","$document","$sce",function(a,b,c){return{templateUrl:"views/render-tree.html",restrict:"E",scope:{data:"=ngModel"},link:function(b){function d(a){a.children&&(a._children=a.children,a._children.forEach(d),a.children=null)}function e(a){var b=q.nodes(n).reverse(),c=q.links(b);b.forEach(function(a){a.y=180*a.depth});var d=u.selectAll("g.node").data(b,function(a){return a.id||(a.id=++o)}),e=d.enter().append("g").attr("class","node").attr("transform",function(){return"translate("+a.y0+","+a.x0+")"}).on("click",f);e.filter(function(a){return"Virtual Laboratories"===a.id?!0:void 0}).append("image").attr("xlink:href","images/logo.png").attr("x",-100).attr("y",-50).attr("width",100).attr("height",100),e.filter(function(a){return"Virtual Laboratories"!==a.id?!0:void 0}).append("circle").attr("r",1e-6).style("fill",function(a){return a._children?"lightsteelblue":"#fff"}),e.append("text").text(function(a){return a.id}).style("fill-opacity",1e-6).style("font",function(){return"15px sans-serif"});var g=d.transition().duration(p).attr("transform",function(a){return"translate("+a.y+","+a.x+")"});g.select("circle").attr("r",10).style("fill",function(a){return a._children?"lightsteelblue":"#fff"}),g.select("text").filter(function(a){return"Virtual Laboratories"!==a.id?!0:void 0}).style("fill-opacity",1).attr("x",function(a){var b=a.attributes.custom_class;return"1"===b?-15:"2"===b?m.length>0?50:15:25}).attr("dy",function(a){var b=a.attributes.custom_class;return"1"===b?"0.35em":"2"===b&&m.length>0?"-1em":"0.35em"}).attr("text-anchor",function(a){var b=a.attributes.custom_class;return"1"===b?"end":"2"===b&&m.length>0?"end":"start"});var h=d.exit().transition().duration(p).attr("transform",function(){return"translate("+a.y+","+a.x+")"}).remove();h.select("circle").attr("r",1e-6),h.select("text").style("fill-opacity",1e-6);var i=u.selectAll("path.link").data(c,function(a){return a.target.id});i.enter().insert("path","g").attr("class","link").attr("d",function(){var b={x:a.x0,y:a.y0};return r({source:b,target:b})}),i.transition().duration(p).attr("d",r),i.exit().transition().duration(p).attr("d",function(){var b={x:a.x,y:a.y};return r({source:b,target:b})}).remove(),b.forEach(function(a){a.x0=a.x,a.y0=a.y})}function f(a){g(a),a.children?(a._children=a.children,a.children=null,m.splice(m.indexOf(a.id),1)):(a.children=a._children,a._children=null,"2"===a.attributes.custom_class&&m.push(a.id)),e(a)}function g(d){void 0!==d.attributes.custom_url&&b.$apply(function(){b.iframePanelStyle={position:"fixed","z-index":"300",top:"100px",left:(a.innerWidth-700)/2,width:"720px",height:.8*a.innerHeight},b.iframeStyle={border:"0","border-radius":"8px","background-color":"white",overflow:"hidden"},b.nodeSelected=!0,b.targetUrl=c.trustAsResourceUrl(d.attributes.custom_url),b.iframeWidth=720,b.iframeHeight=.8*a.innerHeight})}var h,i,j=angular.element(document.querySelector("#header")),k=a.innerWidth,l=a.innerHeight-j[0].clientHeight,m=[];a.innerWidth<1024?(h=150,i=.9):(h=300,i=1),b.position={position:"absolute",top:j[0].clientHeight,left:"0"};var n,o=0,p=750,q=d3.layout.tree().size([l,k]),r=d3.svg.diagonal().projection(function(a){return[a.y,a.x]}),s=function(){d3.select("svg").select("g").attr("transform","translate("+d3.event.translate+") scale("+d3.event.scale+")")},t=d3.behavior.zoom().scale([i]).translate([h,0]).scaleExtent([0,8]).on("zoom",s),u=d3.select("#explorer").append("svg").attr("width",k).attr("height",l).attr("preserveAspectRatio","xMidYMid meet").call(t).append("g").attr("transform","translate("+h+",0)scale("+i+","+i+")");n=b.data,n.x0=l/2,n.y0=0,n.children.forEach(d),e(n),d3.select(self.frameElement).style("height","800px"),b.dismiss=function(){b.nodeSelected=!1},b.openPage=function(){a.location.href=b.targetUrl}}}}]);